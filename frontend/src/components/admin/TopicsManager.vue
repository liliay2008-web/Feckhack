<template>
  <div class="animate-fade-in">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-8 animate-slide-up">
      <h1 class="page-title">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º</h1>
      <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–∞–º–∏ –∫—É—Ä—Å–æ–≤—ã—Ö –∏ –¥–∏–ø–ª–æ–º–Ω—ã—Ö —Ä–∞–±–æ—Ç</p>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="card mb-6 animate-slide-up" style="animation-delay: 0.1s">
      <div class="section-header">
        <div class="section-icon bg-gradient-to-br from-green-500 to-green-600">
          <span class="text-3xl">üìñ</span>
        </div>
        <h2 class="section-title">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h2>
      </div>
      
      <div class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="space-y-2">
            <label class="block text-gray-dark font-semibold mb-2 flex items-center space-x-2">
              <span>üìö</span>
              <span>–ü—Ä–µ–¥–º–µ—Ç:</span>
            </label>
            <input
              v-model="uploadData.subject"
              type="text"
              class="input-field"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç"
            />
          </div>
          <div class="space-y-2">
            <label class="block text-gray-dark font-semibold mb-2 flex items-center space-x-2">
              <span>üè¢</span>
              <span>–¶–ú–ö:</span>
            </label>
            <input
              v-model="uploadData.cmk"
              type="text"
              class="input-field"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –¶–ú–ö"
            />
          </div>
          <div class="space-y-2">
            <label class="block text-gray-dark font-semibold mb-2 flex items-center space-x-2">
              <span>üìù</span>
              <span>–¢–∏–ø —Ä–∞–±–æ—Ç—ã:</span>
            </label>
            <input
              v-model="uploadData.work_type"
              type="text"
              class="input-field"
              placeholder="–ö—É—Ä—Å–æ–≤–∞—è/–î–∏–ø–ª–æ–º–Ω–∞—è"
            />
          </div>
        </div>

        <div class="border-t border-gray-200 pt-6">
          <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
              <input
                type="file"
                ref="fileInput"
                @change="handleFileSelect"
                accept=".xlsx,.xls,.csv"
                class="hidden"
                id="topic-file-input"
              />
              <label
                for="topic-file-input"
                class="inline-flex items-center justify-center space-x-3 px-8 py-4 bg-gradient-to-r from-green-500 via-green-600 to-emerald-600 hover:from-green-600 hover:via-emerald-600 hover:to-emerald-700 text-white font-bold rounded-xl cursor-pointer transition-all duration-300 transform hover:scale-105 hover:shadow-2xl active:scale-95 w-full sm:w-auto glow-effect"
              >
                <span class="text-2xl">üìÅ</span>
                <span class="text-lg">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª (Excel/CSV)</span>
                <span class="text-xl">‚¨ÜÔ∏è</span>
              </label>
            </div>
            <button
              v-if="selectedFile"
              @click="uploadFile"
              :disabled="uploading"
              class="px-8 py-4 bg-gradient-to-r from-green-500 via-green-600 to-emerald-600 hover:from-green-600 hover:via-emerald-600 hover:to-emerald-700 text-white font-bold rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-2xl active:scale-95 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed glow-effect"
            >
              <span v-if="uploading" class="loading-spinner"></span>
              <span v-else class="text-2xl">üöÄ</span>
              <span class="text-lg">{{ uploading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—ã' }}</span>
            </button>
          </div>
          
          <div v-if="selectedFile" class="mt-4 p-5 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl animate-bounce-in shadow-lg">
            <div class="flex items-center space-x-4">
              <div class="p-3 bg-green-500 rounded-full">
                <span class="text-2xl">‚úÖ</span>
              </div>
              <div class="flex-1">
                <p class="font-bold text-green-800 text-lg">–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –∏–º–ø–æ—Ä—Ç—É:</p>
                <p class="text-base text-green-700 font-semibold mt-1">{{ selectedFile.name }}</p>
                <p class="text-sm text-green-600 mt-1">
                  –†–∞–∑–º–µ—Ä: {{ (selectedFile.size / 1024).toFixed(2) }} KB
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–µ–º -->
    <div class="card animate-slide-up" style="animation-delay: 0.2s">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-3">
          <div class="p-2 bg-gradient-to-br from-green-500 to-green-600 rounded-lg">
            <span class="text-2xl">üìö</span>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-dark">–°–ø–∏—Å–æ–∫ —Ç–µ–º</h2>
            <p class="text-sm text-gray-500">–í—Å–µ–≥–æ: {{ topics.length }}</p>
          </div>
        </div>
        <div class="flex space-x-2">
          <div class="px-4 py-2 bg-green-100 text-green-800 rounded-lg font-semibold">
            –°–≤–æ–±–æ–¥–Ω–æ: {{ topics.filter(t => t.status === 'free').length }}
          </div>
          <div class="px-4 py-2 bg-orange-100 text-orange-800 rounded-lg font-semibold">
            –ó–∞–Ω—è—Ç–æ: {{ topics.filter(t => t.status === 'occupied').length }}
          </div>
        </div>
      </div>
      
      <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-inner">
        <table class="topics-table min-w-full divide-y divide-gray-200">
          <thead class="bg-gradient-to-r from-green-600 to-green-700 text-white">
            <tr>
              <th style="width: 80px; text-align: left; padding: 16px 24px;">ID</th>
              <th style="text-align: left; padding: 16px 24px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th style="width: 150px; text-align: left; padding: 16px 24px;">–ü—Ä–µ–¥–º–µ—Ç</th>
              <th style="width: 160px; text-align: left; padding: 16px 24px;">–í–∏–¥ —Ä–∞–±–æ—Ç—ã</th>
              <th style="width: 150px; text-align: left; padding: 16px 24px;">–¶–ú–ö</th>
              <th style="width: 200px; text-align: left; padding: 16px 24px;">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</th>
              <th style="width: 120px; text-align: left; padding: 16px 24px;">–°—Ç–∞—Ç—É—Å</th>
              <th style="width: 200px; text-align: left; padding: 16px 24px;">–°—Ç—É–¥–µ–Ω—Ç</th>
              <th style="width: 180px; text-align: left; padding: 16px 24px;">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100">
            <tr 
              v-for="(topic, index) in topics" 
              :key="topic.id" 
              class="hover:bg-green-50 transition-all duration-300 table-row"
              :style="{ animationDelay: `${index * 0.03}s` }"
            >
              <td style="width: 80px; text-align: left; padding: 16px 24px; vertical-align: top;">
                <span class="font-bold text-green-600">#{{ topic.id }}</span>
              </td>
              <td style="text-align: left; padding: 16px 24px; vertical-align: top;">
                <input
                  v-if="editingId === topic.id"
                  v-model="editingData.title"
                  class="input-field w-full"
                  @keyup.enter="saveTopic(topic.id)"
                  @keyup.esc="cancelEdit"
                />
                <span v-else class="font-medium text-gray-900">{{ topic.title }}</span>
              </td>
              <td style="width: 150px; text-align: left; padding: 16px 24px; vertical-align: top;">
                <input
                  v-if="editingId === topic.id"
                  v-model="editingData.subject"
                  class="input-field w-full"
                  @keyup.enter="saveTopic(topic.id)"
                />
                <span v-else class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                  {{ topic.subject || '-' }}
                </span>
              </td>
              <td style="width: 160px; text-align: left; padding: 16px 24px; vertical-align: top;">
                <input
                  v-if="editingId === topic.id"
                  v-model="editingData.work_type"
                  class="input-field w-full"
                  placeholder="–ö—É—Ä—Å–æ–≤–∞—è/–î–∏–ø–ª–æ–º–Ω–∞—è"
                  @keyup.enter="saveTopic(topic.id)"
                />
                <span v-else class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-semibold">
                  {{ topic.work_type || '-' }}
                </span>
              </td>
              <td style="width: 150px; text-align: left; padding: 16px 24px; vertical-align: top;">
                <input
                  v-if="editingId === topic.id"
                  v-model="editingData.cmk"
                  class="input-field w-full"
                  @keyup.enter="saveTopic(topic.id)"
                />
                <span v-else class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-semibold">
                  {{ topic.cmk || '-' }}
                </span>
              </td>
              <td style="width: 200px; text-align: left; padding: 16px 24px; vertical-align: top;">
                <select
                  v-if="editingId === topic.id"
                  v-model="editingData.supervisor_id"
                  class="input-field w-full"
                >
                  <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
                  <option
                    v-for="supervisor in supervisors"
                    :key="supervisor.id"
                    :value="supervisor.id"
                  >
                    {{ supervisor.full_name }}
                  </option>
                </select>
                <span v-else class="text-gray-700 font-medium">
                  {{ topic.supervisor_name || '–Ω–µ —É–∫–∞–∑–∞–Ω' }}
                </span>
              </td>
              <td style="width: 120px; text-align: left; padding: 16px 24px; vertical-align: top;">
                <span
                    class="status-badge"
                    :class="{
                      'status-free': topic.status === 'free',
                      'status-occupied': topic.status === 'occupied',
                      'status-reserved': topic.status === 'reserved'
                    }"
                >
                  {{ getStatusText(topic.status) }}
                </span>
              </td>
              <td style="width: 200px; text-align: left; padding: 16px 24px; vertical-align: top;">
                <span v-if="topic.student_name" class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-semibold">
                  {{ topic.student_name }}
                </span>
                <span v-else class="text-gray-400">-</span>
              </td>
              <td style="width: 180px; text-align: left; padding: 16px 24px; vertical-align: top;">
                <div v-if="editingId === topic.id" class="flex space-x-2">
                  <button
                    @click="saveTopic(topic.id)"
                    class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-md flex items-center space-x-1"
                  >
                    <span>‚úì</span>
                    <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                  </button>
                  <button
                    @click="cancelEdit"
                    class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-all duration-300 transform hover:scale-105 active:scale-95 flex items-center space-x-1"
                  >
                    <span>‚úï</span>
                    <span>–û—Ç–º–µ–Ω–∞</span>
                  </button>
                </div>
                <div v-else class="flex space-x-2">
                  <button
                    @click="editTopic(topic)"
                    class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-md flex items-center space-x-1"
                  >
                    <span>‚úèÔ∏è</span>
                    <span>–ò–∑–º–µ–Ω–∏—Ç—å</span>
                  </button>
                  <button
                    @click="deleteTopic(topic.id)"
                    class="px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg hover:from-red-600 hover:to-red-700 transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-md flex items-center space-x-1"
                  >
                    <span>üóëÔ∏è</span>
                    <span>–£–¥–∞–ª–∏—Ç—å</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div v-if="topics.length === 0" class="text-center py-16">
        <div class="inline-block p-6 bg-gray-100 rounded-full mb-4">
          <span class="text-6xl">üì≠</span>
        </div>
        <p class="text-xl font-semibold text-gray-600 mb-2">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ç–µ–º</p>
        <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª Excel/CSV –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { ElMessage } from 'element-plus';
import api from '../../api/axios';

const topics = ref([]);
const supervisors = ref([]);
const selectedFile = ref(null);
const uploading = ref(false);
const editingId = ref(null);
const editingData = ref({});

const uploadData = ref({
  subject: '',
  cmk: '',
  work_type: ''
});

onMounted(() => {
  loadTopics();
  loadSupervisors();
});

const loadTopics = async () => {
  try {
    const response = await api.get('/admin/topics');
    topics.value = (response.data || []).map(t => ({
      id: t.id,
      title: t.title,
      description: t.description || null,
      subject: t.subject_name || t.subject || null,
      cmk: t.commission_name || t.cmk || null,
      work_type: t.work_type || null,
      supervisor_id: t.supervisor_id || null,
      supervisor_name: t.supervisor_full_name || null,
      status: t.status || (t.assigned_student_id ? 'occupied' : 'free'),
      student_name: t.student_name || t.assigned_student_full_name || null,
      student_group: t.student_group || null
    }));
  } catch (error) {
    ElMessage.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º');
  }
};

const loadSupervisors = async () => {
  try {
    const response = await api.get('/admin/supervisors');
    supervisors.value = response.data;
  } catch (error) {
    ElMessage.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π');
  }
};

const handleFileSelect = (event) => {
  selectedFile.value = event.target.files[0];
};

const uploadFile = async () => {
  if (!selectedFile.value) return;

  uploading.value = true;
  const formData = new FormData();
  formData.append('file', selectedFile.value);
  formData.append('subject', uploadData.value.subject);
  formData.append('cmk', uploadData.value.cmk);
  formData.append('work_type', uploadData.value.work_type);

  try {
    const response = await api.post('/admin/upload/topics', formData, {
      headers: {
        'Content-Type': 'multipart/form-data'
      }
    });

    ElMessage.success(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${response.data.imported || 0} —Ç–µ–º`);
    selectedFile.value = null;
    document.getElementById('topic-file-input').value = '';
    uploadData.value = { subject: '', cmk: '', work_type: '' };
    loadTopics();
  } catch (error) {
    ElMessage.error(error.response?.data?.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
  } finally {
    uploading.value = false;
  }
};

const getStatusText = (status) => {
  const statusMap = {
    free: '–°–≤–æ–±–æ–¥–Ω–∞',
    occupied: '–ó–∞–Ω—è—Ç–∞',
    locked: '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞',
    in_progress: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'
  };
  return statusMap[status] || status;
};

const editTopic = (topic) => {
  editingId.value = topic.id;
  editingData.value = {
    title: topic.title,
    subject: topic.subject || '',
    cmk: topic.cmk || '',
    work_type: topic.work_type || '',
    supervisor_id: topic.supervisor_id || null
  };
};

const cancelEdit = () => {
  editingId.value = null;
  editingData.value = {};
};

const saveTopic = async (id) => {
  try {
    if (editingData.value.supervisor_id !== undefined) {
      await api.post(`/admin/topics/${id}/supervisor`, { supervisor_id: editingData.value.supervisor_id || null });
      ElMessage.success('–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
    } else {
      ElMessage.info('–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è');
    }
    editingId.value = null;
    editingData.value = {};
    loadTopics();
  } catch (error) {
    ElMessage.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–º—ã');
  }
};

const deleteTopic = async (id) => {
  ElMessage.warning('–£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
};
</script>

<style scoped>
.table-row {
  animation: tableRow 0.4s ease-out forwards;
  opacity: 0;
}

@keyframes tableRow {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Ç–µ–º */
.topics-table {
  table-layout: auto;
  border-collapse: collapse;
}

.topics-table thead th {
  text-align: left !important;
  vertical-align: middle !important;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.topics-table tbody td {
  text-align: left !important;
  vertical-align: top !important;
}

.topics-table tbody tr {
  position: relative;
}

.topics-table tbody tr::before {
  display: none !important;
}

.topics-table tbody tr:hover {
  transform: none !important;
  background: rgba(34, 197, 94, 0.05) !important;
}
</style>
