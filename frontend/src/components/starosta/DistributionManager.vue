<template>
  <div class="animate-fade-in">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-8 animate-slide-up">
      <h1 class="text-4xl font-bold gradient-text mb-2">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º</h1>
      <p class="text-gray-600">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω—É—é —Ç–µ–º—É –∏ –Ω–∞–∑–Ω–∞—á—å—Ç–µ –µ—ë —Å—Ç—É–¥–µ–Ω—Ç—É –∏–∑ –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã</p>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="card mb-6 card-hover animate-slide-up bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200" style="animation-delay: 0.1s">
      <div class="flex items-start space-x-4">
        <div class="p-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl shadow-lg">
          <span class="text-3xl">‚ÑπÔ∏è</span>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-bold text-gray-dark mb-2">–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
          <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
            <li>–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–∑–Ω–∞—á–∞—Ç—å —Ç–æ–ª—å–∫–æ <strong>—Å–≤–æ–±–æ–¥–Ω—ã–µ —Ç–µ–º—ã</strong></li>
            <li>–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã —É –≤–∞—Å –µ—Å—Ç—å <strong>30 –º–∏–Ω—É—Ç</strong> –Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö</li>
            <li>–ï—Å–ª–∏ –ø–æ–ª—è –Ω–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç (–∫—Ä–æ–º–µ –ø–æ–ª—è "–Ω–∞—É—á–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å"), —Ç–µ–º–∞ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö</li>
            <li>–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω—è—Ç—å —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Ç–µ–º—ã</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ç–µ–º -->
    <div class="card animate-slide-up" style="animation-delay: 0.2s">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-3">
          <div class="p-2 bg-gradient-to-br from-green-500 to-green-600 rounded-lg">
            <span class="text-2xl">üìù</span>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-dark">–°–≤–æ–±–æ–¥–Ω—ã–µ —Ç–µ–º—ã</h2>
            <p class="text-sm text-gray-500">–î–æ—Å—Ç—É–ø–Ω–æ: {{ freeTopics.length }}</p>
          </div>
        </div>
      </div>
      
      <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-inner">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gradient-to-r from-green-600 to-green-700 text-white">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">–¢–µ–º–∞</th>
              <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">–ü—Ä–µ–¥–º–µ—Ç</th>
              <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">–¶–ú–ö</th>
              <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</th>
              <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">–°—Ç–∞—Ç—É—Å</th>
              <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100">
            <tr 
              v-for="(topic, index) in freeTopics" 
              :key="topic.id" 
              class="hover:bg-green-50 transition-all duration-300 table-row"
              :style="{ animationDelay: `${index * 0.03}s` }"
            >
              <td class="px-6 py-4">
                <span class="font-medium text-gray-900">{{ topic.title }}</span>
              </td>
              <td class="px-6 py-4">
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                  {{ topic.subject || '-' }}
                </span>
              </td>
              <td class="px-6 py-4">
                <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-semibold">
                  {{ topic.cmk || '-' }}
                </span>
              </td>
              <td class="px-6 py-4">
                <span class="text-gray-700 font-medium">
                  {{ topic.supervisor_name || '<span class="text-gray-400">–Ω–µ —É–∫–∞–∑–∞–Ω</span>' }}
                </span>
              </td>
              <td class="px-6 py-4">
                <span
                  class="px-3 py-1 rounded-full text-xs font-bold transition-all duration-300"
                  :style="{
                    background: topic.status === 'free' 
                      ? 'linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%)'
                      : 'linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%)',
                    color: topic.status === 'free' ? '#059669' : '#D97706'
                  }"
                >
                  {{ getStatusText(topic.status) }}
                </span>
              </td>
              <td class="px-6 py-4">
                <button
                  v-if="topic.status === 'free'"
                  @click="selectTopic(topic)"
                  class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-md flex items-center space-x-1"
                >
                  <span>‚úì</span>
                  <span>–í—ã–±—Ä–∞—Ç—å</span>
                </button>
                <span 
                  v-else-if="topic.status === 'locked'"
                  class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold"
                >
                  –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
                </span>
                <span 
                  v-else 
                  class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-semibold"
                >
                  –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div v-if="freeTopics.length === 0" class="text-center py-16">
        <div class="inline-block p-6 bg-gray-100 rounded-full mb-4">
          <span class="text-6xl">üì≠</span>
        </div>
        <p class="text-xl font-semibold text-gray-600 mb-2">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ç–µ–º</p>
        <p class="text-gray-500">–í—Å–µ —Ç–µ–º—ã —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã</p>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è -->
    <el-dialog
      v-model="showDialog"
      title="–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–º—ã"
      width="600px"
      class="dialog-custom"
    >
      <div v-if="selectedTopic" class="space-y-6">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–º–µ -->
        <div class="p-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl border-2 border-purple-200">
          <div class="flex items-center space-x-3 mb-2">
            <span class="text-2xl">üìö</span>
            <h3 class="text-lg font-bold text-gray-dark">–¢–µ–º–∞</h3>
          </div>
          <p class="text-gray-700 font-medium">{{ selectedTopic.title }}</p>
          <div class="mt-2 flex space-x-4 text-sm text-gray-600">
            <span v-if="selectedTopic.subject">–ü—Ä–µ–¥–º–µ—Ç: {{ selectedTopic.subject }}</span>
            <span v-if="selectedTopic.cmk">–¶–ú–ö: {{ selectedTopic.cmk }}</span>
          </div>
        </div>

        <!-- –í—ã–±–æ—Ä —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
        <div>
          <label class="block text-gray-dark font-semibold mb-3 flex items-center space-x-2">
            <span>üë§</span>
            <span>–°—Ç—É–¥–µ–Ω—Ç –∏–∑ –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã:</span>
          </label>
          <el-select
            v-model="assignmentData.student_id"
            placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞"
            class="w-full"
            size="large"
          >
            <el-option
              v-for="student in myGroupStudents"
              :key="student.id"
              :label="`${student.full_name} ${student.phone ? '(' + student.phone + ')' : ''}`"
              :value="student.id"
            />
          </el-select>
        </div>

        <!-- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
        <div>
          <label class="block text-gray-dark font-semibold mb-3 flex items-center space-x-2">
            <span>üì±</span>
            <span>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω):</span>
          </label>
          <input
            v-model="assignmentData.phone"
            type="tel"
            class="input-field"
            placeholder="+7 (___) ___-__-__"
          />
        </div>

        <!-- –ù–∞—É—á–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å -->
        <div>
          <label class="block text-gray-dark font-semibold mb-3 flex items-center space-x-2">
            <span>üë®‚Äçüè´</span>
            <span>–ù–∞—É—á–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:</span>
          </label>
          <el-select
            v-model="assignmentData.supervisor_id"
            placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è"
            class="w-full"
            size="large"
          >
            <el-option
              v-for="supervisor in supervisors"
              :key="supervisor.id"
              :label="supervisor.full_name"
              :value="supervisor.id"
            />
          </el-select>
        </div>

        <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ -->
        <div v-if="lockedUntil" class="p-5 bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl animate-bounce-in">
          <div class="flex items-start space-x-3">
            <span class="text-3xl">‚ö†Ô∏è</span>
            <div class="flex-1">
              <p class="text-yellow-900 font-bold mb-2 text-lg">
                –í–Ω–∏–º–∞–Ω–∏–µ! –¢–µ–º–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ 30 –º–∏–Ω—É—Ç
              </p>
              <p class="text-yellow-800 text-sm mb-3">
                –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏. –ï—Å–ª–∏ –ø–æ–ª—è –Ω–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç (–∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –ø–æ–ª—è "–Ω–∞—É—á–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å"), —Ç–µ–º–∞ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö.
              </p>
              <div class="flex items-center space-x-2 bg-yellow-100 px-4 py-2 rounded-lg">
                <span class="text-2xl">‚è∞</span>
                <div>
                  <p class="text-xs text-yellow-700 font-semibold">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏:</p>
                  <p class="text-xl font-bold text-yellow-900">{{ timeLeft }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <template #footer>
        <div class="flex justify-end space-x-4">
          <button
            @click="showDialog = false"
            class="px-6 py-3 bg-gray-400 text-white rounded-xl hover:bg-gray-500 transition-all duration-300 transform hover:scale-105 active:scale-95 font-semibold"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            @click="assignTopic"
            :disabled="!assignmentData.student_id"
            class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center space-x-2"
          >
            <span>‚úì</span>
            <span>–ù–∞–∑–Ω–∞—á–∏—Ç—å</span>
          </button>
          <button
            v-if="lockedUntil && assignmentData.supervisor_id"
            @click="completeAssignment"
            class="px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-lg font-semibold flex items-center space-x-2"
          >
            <span>‚úÖ</span>
            <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</span>
          </button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, onMounted, computed, onUnmounted } from 'vue';
import { ElMessage } from 'element-plus';
import { useAuthStore } from '../../stores/auth';
import api from '../../api/axios';

const authStore = useAuthStore();
const topics = ref([]);
const students = ref([]);
const supervisors = ref([]);
const showDialog = ref(false);
const selectedTopic = ref(null);
const assignmentData = ref({
  student_id: null,
  phone: '',
  supervisor_id: null
});
const lockedUntil = ref(null);
const timeLeft = ref('');
const timer = ref(null);

const myGroupStudents = computed(() => {
  const userGroups = authStore.user?.groups || [];
  return students.value.filter(s => userGroups.includes(s.group_name));
});

const freeTopics = computed(() => {
  return topics.value.filter(t => t.status === 'free' || t.status === 'locked');
});

onMounted(() => {
  loadData();
  startTimer();
});

onUnmounted(() => {
  if (timer.value) {
    clearInterval(timer.value);
  }
});

const loadData = async () => {
  await Promise.all([loadTopics(), loadStudents(), loadSupervisors()]);
};

const loadTopics = async () => {
  try {
    const response = await api.get('/topics');
    topics.value = response.data;
  } catch (error) {
    ElMessage.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º');
  }
};

const loadStudents = async () => {
  try {
    const response = await api.get('/admin/students');
    students.value = response.data;
  } catch (error) {
    ElMessage.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤');
  }
};

const loadSupervisors = async () => {
  try {
    const response = await api.get('/supervisors');
    supervisors.value = response.data;
  } catch (error) {
    ElMessage.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π');
  }
};

const getStatusText = (status) => {
  const statusMap = {
    free: '–°–≤–æ–±–æ–¥–Ω–∞',
    occupied: '–ó–∞–Ω—è—Ç–∞',
    locked: '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞'
  };
  return statusMap[status] || status;
};

const selectTopic = (topic) => {
  selectedTopic.value = topic;
  assignmentData.value = {
    student_id: null,
    phone: '',
    supervisor_id: null
  };
  lockedUntil.value = null;
  showDialog.value = true;
};

const assignTopic = async () => {
  if (!selectedTopic.value || !assignmentData.value.student_id) return;

  try {
    const response = await api.post(`/topics/${selectedTopic.value.id}/assign`, {
      student_id: assignmentData.value.student_id,
      phone: assignmentData.value.phone || null,
      supervisor_id: assignmentData.value.supervisor_id || null
    });

    if (response.data.locked_until) {
      lockedUntil.value = new Date(response.data.locked_until);
      ElMessage.warning('–¢–µ–º–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ 30 –º–∏–Ω—É—Ç. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏.');
      startTimer();
    } else {
      ElMessage.success('–¢–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞');
      showDialog.value = false;
      loadTopics();
    }
  } catch (error) {
    ElMessage.error(error.response?.data?.error || '–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ–º—ã');
  }
};

const completeAssignment = async () => {
  if (!selectedTopic.value || !assignmentData.value.supervisor_id) return;

  try {
    await api.post(`/topics/${selectedTopic.value.id}/complete`, {
      supervisor_id: assignmentData.value.supervisor_id
    });

    ElMessage.success('–¢–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞');
    showDialog.value = false;
    lockedUntil.value = null;
    if (timer.value) {
      clearInterval(timer.value);
    }
    loadTopics();
  } catch (error) {
    ElMessage.error(error.response?.data?.error || '–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
  }
};

const startTimer = () => {
  if (timer.value) {
    clearInterval(timer.value);
  }

  timer.value = setInterval(() => {
    if (lockedUntil.value) {
      const now = new Date();
      const locked = new Date(lockedUntil.value);
      const diff = locked - now;

      if (diff <= 0) {
        timeLeft.value = '–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ';
        lockedUntil.value = null;
        clearInterval(timer.value);
        ElMessage.warning('–í—Ä–µ–º—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏—Å—Ç–µ–∫–ª–æ. –¢–µ–º–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞.');
        showDialog.value = false;
        loadTopics();
      } else {
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        timeLeft.value = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      }
    }
  }, 1000);
};
</script>

<style scoped>
.table-row {
  animation: tableRow 0.4s ease-out forwards;
  opacity: 0;
}

@keyframes tableRow {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
:deep(.el-dialog) {
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

:deep(.el-dialog__header) {
  padding: 24px 24px 16px;
  border-bottom: 2px solid #f3f4f6;
}

:deep(.el-dialog__title) {
  font-size: 24px;
  font-weight: bold;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

:deep(.el-dialog__body) {
  padding: 24px;
}

:deep(.el-dialog__footer) {
  padding: 16px 24px 24px;
  border-top: 2px solid #f3f4f6;
}
</style>
